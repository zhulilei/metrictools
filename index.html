<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="Metrictools :  Distributed system monitor toolset" />
    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">
    <title>Metrictools</title>
  </head>

  <body>

    
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/datastream/metrictools">View on GitHub</a>
          <h1 id="project_title">Metrictools</h1>
          <h2 id="project_tagline"> Distributed system monitor toolset</h2>
            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/datastream/metrictools/zipball/master">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/datastream/metrictools/tarball/master">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

    
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
<h1>Introducing metrictools</h1>

<p>It&rsquo;s distributed system monitoring solution. It support collectd&rsquo;s json format data.</p>

<p><img src="images/metrictools-struct.png" alt="metrictools" />
</p>

<h2>Metrictools Subsystem</h2>

<h3>process</h3>

<p><code>processor</code> module read collectd json data from nsq, parse json and store data into redis.
it also check metrics&rsquo; archive time, and send metrics&rsquo; name to <code>archive</code>.</p>

<p><code>processor</code> scan all records in redis which match <code>trigger:*</code>, and send them to <code>metricstatistic</code></p>

<p><em>Date Flow</em></p>

<pre><code>collectd -&gt; webapi -&gt; nsq -&gt; process -&gt; redis
</code></pre>

<h3>archive</h3>

<p><code>archive</code> read metric name from nsq, compress and remove old data.</p>

<p><em>Date Flow</em></p>

<pre><code>processor -&gt; nsq -&gt; archive -&gt; redis
</code></pre>

<h3>statistic</h3>

<p><code>statistic</code> read trigger from nsq, then calculate triggers&rsquo; expression.
It also use <code>etsy/skyline</code> algorithms to check data. If skyline algorithms return true, send data to <code>metricnotify</code>.</p>

<p><em>Date Flow</em></p>

<pre><code># calculate expression
processor -&gt; nsq -&gt; archive -&gt; redis
# skyline
redis -&gt; archive -&gt; nsq -&gt; notify
</code></pre>

<h3>webapi</h3>

<p><code>webapi</code> is a web api, it provide data from redis.</p>

<p><em>Date Flow</em></p>

<pre><code>webapi &lt;-&gt; redis
</code></pre>

<p>See also (github.com/datastream/metricweb)</p>

<h3>notify</h3>

<p><code>notify</code> read data, and send data via email, http etc.</p>

<p><em>Date Flow</em></p>

<pre><code>statistic -&gt; nsq -&gt; notify -&gt; email/http/im etc.
</code></pre>

<p>All these tools communicate data via nsq.</p>

<h2>How to Setup</h2>

<h3>Require</h3>

<ol>
<li>collectd v4.8+ (write_http plugin)</li>
<li>nsq</li>
<li>redis (optional twemproxy)</li>
</ol>

<h4>collectd</h4>

<p>collectd runs on every node, and send data to nsq api via http.</p>

<pre><code>&lt;Plugin write_http&gt;
  &lt;URL &quot;http://nsq_node:4151/put?topic=metric&quot;&gt;
    Format &quot;JSON&quot;
    User &quot;instance_name&quot;
    Password &quot;user_token&quot;
  &lt;/URL&gt;
&lt;/Plugin&gt;
</code></pre>

<h4>nsq</h4>

<p><a href="http://bitly.github.io/nsq/overview/quick_start.html">Quick Start</a></p>

<h4>redis</h4>

<p>on debian</p>

<pre><code>apt-get install redis-server
service redis-server start
</code></pre>

<p>on freebsd</p>

<pre><code>cd /usr/ports/databases/redis;make install
service redis-server start
</code></pre>

<p>on mac ox x</p>

<pre><code>brew install redis-server
/usr/local/bin/redis-server
</code></pre>

<h4>data struct in redis</h4>

<p><code>SMEMBERS hosts</code></p>

<pre><code>1) 192.169.21.1
2) 192.169.21.2
...
</code></pre>

<p><code>SMEMBERS 192.169.21.1</code></p>

<pre><code>1) 192.169.21.2_cpu7_interrupt
2) 192.169.21.2_cpu27_steal
...
</code></pre>

<p><code>HGETALL 192.169.21.2_interface_eth2.if_errors.rx</code></p>

<pre><code>1) &quot;value&quot;
2) &quot;0&quot;
3) &quot;timestamp&quot;
4) &quot;1392798179&quot;
5) &quot;rate_value&quot;
6) &quot;0&quot;
7) &quot;ttl&quot;
8) &quot;10800&quot;
9) &quot;archivetime&quot;
10) &quot;1392797701&quot;
11) &quot;5mins&quot;
12) &quot;1390006167&quot;
13) &quot;10mins&quot;
14) &quot;1391983767&quot;
15) &quot;15mins&quot;
16) &quot;1392192867&quot;
</code></pre>

<p><code>SMEMBERS triggers</code></p>

<pre><code>1) 192.169.21.2_cpu7_interrupt
2) 192.169.21.2_cpu2_interrupt
3) 192.169.21.2_cpu2_interrupt+192.169.21.2_cpu5_interrupt
</code></pre>

<p><code>ZRANGEBYSCORE archive:192.169.21.2_cpu2_interrupt</code></p>

<pre><code>1) &quot;1392192867:1&quot;
2) &quot;1392192927:1&quot;
...
</code></pre>

<p><code>ZRANGEBYSCORE archive:192.169.21.2_cpu2_interrupt+192.169.21.2_cpu5_interrupt</code></p>

<pre><code>1) &quot;1392192867:4&quot;
2) &quot;1392192927:4&quot;
</code></pre>

<p><code>SMEMBERS 192.169.21.2_cpu2_interrupt+192.169.21.2_cpu5_interrupt:actions</code></p>

<pre><code>1) &quot;uri&quot;
2) &quot;mailto:xxx@xxx.com&quot;
3) &quot;updated_time&quot;
4) &quot;1390006167&quot;
5) &quot;repeat&quot;
6) &quot;3&quot;
7) &quot;count&quot;
8) &quot;0&quot;
</code></pre>

<h4>twemproxy</h4>

<p>metrictools support <a href="https://github.com/twitter/twemproxy">twemproxy</a> now.</p>

<h4>metrictools</h4>

<pre><code>git clone github.com/datastream/metrictools
cd metrictools;make
vim metrictools.json

{
  &quot;nsqd_addr&quot;:&quot;127.0.0.1:4151&quot;,
  &quot;lookupd_addresses&quot;:[&quot;127.0.0.1:4160&quot;],
  &quot;metric_topic&quot;:&quot;metric&quot;,
  &quot;metric_channel&quot;:&quot;metric_ch&quot;,
  &quot;trigger_topic&quot;:&quot;trigger&quot;,
  &quot;trigger_channel&quot;:&quot;trigger_ch&quot;,
  &quot;archive_topic&quot;:&quot;archive&quot;,
  &quot;archive_channel&quot;:&quot;archive_ch&quot;,
  &quot;notify_topic&quot;:&quot;notify&quot;,
  &quot;notify_channel&quot;:&quot;notify_ch&quot;,
  &quot;notify_email_address&quot;:&quot;notify@test.org&quot;
  &quot;redis_server&quot;:&quot;127.0.0.1:6379&quot;,
  &quot;full_duration&quot;:86400,
  &quot;consensus&quot;:6,
  &quot;maxinflight&quot;:200,
  &quot;listen_address&quot;:&quot;127.0.0.1:1234&quot;,
  &quot;modes&quot;:[&quot;archive&quot;, &quot;notify&quot;, &quot;process&quot;, &quot;statistic&quot;, &quot;webapi&quot;]
}
</code></pre>

<h5>Run metrictools</h5>

<ol>
<li><code>./metrictools -c metrictools.json</code></li>
</ol>

<h2>Todo</h2>

<ol>
<li>improve anomalous metric detect algorithms</li>
<li>improve data record, reduce redis data size</li>
</ol>
      </section>
    </div>

    
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">Metrictools maintained by <a href="https://github.com/datastream">datastream</a></p>
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>
  </body>
</html>
